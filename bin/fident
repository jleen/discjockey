#!/bin/zsh

[[ -f ~/.dj ]] && . ~/.dj

DOIT="python ${0%/*}/../py/djident.py --client $DJ_GRACENOTE_CLIENT --user $DJ_GRACENOTE_USER"

if [[ $1 == "-x" ]]; then
    DOIT="$DOIT --nometa"
    shift
fi

if [[ -n $2 ]]; then
    discs=$2
else
    discs=1
fi

while [[ $(( discs -= 1 )) -ge 0 ]]; do
    if [[ -n $1 ]]; then
        mkdir -p "`dirname $1`"
        if [[ -n $subsequent ]]; then
            eval $DOIT | tee -a $1
        else
            eval $DOIT | tee $1
        fi
    else
        eval $DOIT
    fi
    if [[ $discs -ge 1 ]]; then
        [[ `uname` == 'Darwin' ]] && drutil eject
        echo ''
        echo ''
        if [[ `uname` == 'Darwin' ]]; then
            echo '--- Insert next disc ---'
            dwait
        else
            echo '--- Insert next disc and hit Enter ---'
            read whatever
        fi
        if [[ -n $1 ]]; then
            echo '~~~' >> $1
            subsequent=1
        fi
    fi
done

[[ -n $2 && `uname` == 'Darwin' ]] && drutil eject
