#!/bin/zsh

[[ -f ~/.dj ]] && . ~/.dj

if [[ -f $1 ]]; then
    echo "Already exists: $1" > /dev/stderr
    exit 1
fi

DOIT="python ${0%/*}/../py/djident.py --client $DJ_GRACENOTE_CLIENT --user $DJ_GRACENOTE_USER"

if [[ $1 == "-x" ]]; then
    DOIT="$DOIT --nometa"
    shift
fi

if [[ -n $2 ]]; then
    num_discs=$2
else
    num_discs=1
fi
disc_num=1

while [[ $disc_num -le $num_discs ]]; do
    if [[ -n $1 ]]; then
        mkdir -p "`dirname $1`"
        if [[ -n $subsequent ]]; then
            eval $DOIT | tee -a $1
        else
            eval $DOIT | tee $1
        fi
    else
        eval $DOIT
    fi
    if [[ $((disc_num += 1)) -le $num_discs ]]; then
        [[ `uname` == 'Darwin' ]] && drutil eject
        echo ''
        echo ''
        if [[ `uname` == 'Darwin' ]]; then
            echo "--- Insert disc $disc_num of $num_discs ---"
            dwait
        else
            echo "--- Insert disc $disc_num of $num_discs and hit Enter ---"
            read whatever
        fi
        if [[ -n $1 ]]; then
            echo '~~~' >> $1
            subsequent=1
        fi
    fi
done

[[ -n $2 && `uname` == 'Darwin' ]] && drutil eject
