#!/usr/bin/env zsh

[[ -f ~/.dj ]] && . ~/.dj

PYTHON=${DJ_PYTHON:-python3}
MUSIC=${DJ_MUSIC:-~/music}
CATALOG=${DJ_CATALOG:-~/catalog}

MORE_ARGS=()

# The AFP logic is mostly here for the sake of Mac OS.
if [[ -n $DJ_AFP_CATALOG ]]; then
    host=`echo $DJ_AFP_CATALOG | cut -d: -f1`
    share=`echo $DJ_AFP_CATALOG | cut -d: -f2`
    dir=`echo $DJ_AFP_CATALOG | cut -d: -f3`
    mount=`mount | grep $host | grep $share | cut -d' ' -f3`
    CATALOG=$mount/$dir
fi
if [[ -n $DJ_AFP_MUSIC ]]; then
    host=`echo $DJ_AFP_MUSIC | cut -d: -f1`
    share=`echo $DJ_AFP_MUSIC | cut -d: -f2`
    dir=`echo $DJ_AFP_MUSIC | cut -d: -f3`
    mount=`mount | grep $host | grep $share | cut -d' ' -f3`
    MUSIC=$mount/$dir
fi

PYTHONPATH="${0%/*}/../py:$PYTHONPATH" $PYTHON -m djrip \
    --rename \
    --album="$1" \
    --metaflac_bin=metaflac \
    --catalog="$CATALOG" \
    --music="$MUSIC"
