#!/usr/bin/env zsh

[[ -f ~/.dj ]] && . ~/.dj

album=$1

src=$DJ_SCRATCH
dest=$DJ_MUSIC/$album

if [[ -d $dest ]]; then
    echo "Already exists: $dest" > /dev/stderr
    exit 1
fi

mkdir -p $dest

if [[ -n $2 ]]; then
    num_discs=$2
else
    num_discs=1
fi

for disc in {01..$num_discs}; do
    echo "--- Insert disc $(($disc)) of $num_discs ---"
    dwait
    echo "Ripping via external ripper..."
    $DJ_EXTERNAL_RIPPER
    cdrecord -eject > /dev/null 2>&1

    for track in $src/*.flac; do
        destfile="$dest/disc${disc}track`basename $track`"

        echo "Archiving track $(($disc))..."
        cp -i $track $destfile

        echo "Verifying track $(($disc))..."
        diff -q $track $destfile || exit 2

        rm $track
    done

    echo
done
