#!/usr/bin/env zsh

[[ -f ~/.dj ]] && . ~/.dj

PYTHON=${DJ_PYTHON:-python}
MUSIC=${DJ_MUSIC:-~/music}
CATALOG=${DJ_CATALOG:-~/catalog}

MORE_ARGS=()

if [[ `uname` == Darwin ]]; then
    if [[ -n $DJ_AFP_CATALOG ]]; then
        host=`echo $DJ_AFP_CATALOG | cut -d: -f1`
        share=`echo $DJ_AFP_CATALOG | cut -d: -f2`
        dir=`echo $DJ_AFP_CATALOG | cut -d: -f3`
        mount=`mount | grep $host | grep $share | cut -d' ' -f3`
        CATALOG=$mount/$dir
    fi
    if [[ -n $DJ_AFP_MUSIC ]]; then
        host=`echo $DJ_AFP_MUSIC | cut -d: -f1`
        share=`echo $DJ_AFP_MUSIC | cut -d: -f2`
        dir=`echo $DJ_AFP_MUSIC | cut -d: -f3`
        mount=`mount | grep $host | grep $share | cut -d' ' -f3`
        MUSIC=$mount/$dir
    fi
    CDROM=${DJ_CDROM:-/`drutil status|grep Name|cut -d/ -f2-`}
    EJECT='/usr/bin/drutil eject'
    MORE_ARGS+=("--umount_cmd=/usr/sbin/diskutil unmount $CDROM")
else
    CDROM=${DJ_CDROM:-/dev/cdrom}
    EJECT=${DJ_EJECT:-"eject $CDROM"}
fi
    
if [ "$1" = "-f" ]; then
    MORE_ARGS+=("--allow_wrong_length")
    shift
fi

if [[ $2 == "m3u" ]]; then
    MORE_ARGS+=("--rename")
elif [[ -n $2 ]]; then
    MORE_ARGS+=("--nocreate_playlists" "--first_disc" $2)
fi

$PYTHON ${0%/*}/../py/djrip.py \
    --album="$1" \
    --catalog="$CATALOG" \
    --music="$MUSIC" \
    --eject_cmd=$EJECT \
    --discid_cmd="cd-discid $CDROM" \
    --cdparanoia_bin=cdparanoia \
    --flac_bin=flac \
    $MORE_ARGS
